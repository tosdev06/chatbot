<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tosdev Chatbot</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Fira+Code&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary-color: #3b82f6;
            --secondary-color: #2563eb;
            --user-bubble: #3b82f6;
            --bot-bubble: #e2e8f0;
            --text-dark: #1e293b;
            --text-light: #f8fafc;
            --bg-color: #f1f5f9;
            --border-radius: 12px;
            --box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            --transition: all 0.3s ease;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
        }

        body {
            background-color: var(--bg-color);
            color: var(--text-dark);
            line-height: 1.6;
            height: 100vh;
            display: flex;
            flex-direction: column;
        }

        .header {
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
            color: white;
            padding: 1rem;
            display: flex;
            align-items: center;
            justify-content: space-between;
            box-shadow: var(--box-shadow);
            position: sticky;
            top: 0;
            z-index: 100;
        }

        .header-content {
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .header i {
            font-size: 1.5rem;
        }

        .header h1 {
            font-size: 1.5rem;
            font-weight: 600;
        }

        .clear-chat {
            background: rgba(255, 255, 255, 0.2);
            border: none;
            color: white;
            padding: 0.5rem 1rem;
            border-radius: var(--border-radius);
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            transition: var(--transition);
            font-size: 0.9rem;
        }

        .clear-chat:hover {
            background: rgba(255, 255, 255, 0.3);
        }

        .chat-wrapper {
            max-width: 800px;
            width: 100%;
            margin: 0 auto;
            padding: 1rem;
            display: flex;
            flex-direction: column;
            flex: 1;
            height: calc(100vh - 70px);
        }

        .chat-container {
            flex: 1;
            overflow-y: auto;
            padding: 1rem;
            background-color: white;
            border-radius: var(--border-radius);
            box-shadow: var(--box-shadow);
            margin-bottom: 1rem;
            display: flex;
            flex-direction: column;
            gap: 1rem;
        }

        .message {
            max-width: 85%;
            animation: fadeIn 0.3s ease;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .message-content {
            padding: 0.75rem 1rem;
            border-radius: var(--border-radius);
            position: relative;
            word-wrap: break-word;
            line-height: 1.5;
        }

        .message-content img {
            max-width: 100%;
            max-height: 300px;
            border-radius: var(--border-radius);
            margin: 0.5rem 0;
            border: 1px solid #e2e8f0;
            box-shadow: var(--box-shadow);
            display: block;
            object-fit: contain;
        }

        .image-caption {
            font-size: 0.8rem;
            color: #64748b;
            text-align: center;
            margin-top: 0.25rem;
            font-style: italic;
        }

        .user-message {
            align-self: flex-end;
            background-color: var(--user-bubble);
            color: var(--text-light);
            border-bottom-right-radius: 4px;
        }

        .bot-message {
            align-self: flex-start;
            background-color: var(--bot-bubble);
            color: var(--text-dark);
            border-bottom-left-radius: 4px;
        }

        .message-with-avatar {
            display: flex;
            gap: 0.75rem;
            align-items: flex-start;
        }

        .bot-avatar {
            background-color: var(--secondary-color);
            color: white;
            width: 36px;
            height: 36px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
        }

        .timestamp {
            font-size: 0.75rem;
            color: #64748b;
            margin-top: 0.25rem;
            text-align: right;
        }

        .input-area {
            display: flex;
            gap: 0.5rem;
            padding: 0.75rem;
            background-color: white;
            border-radius: var(--border-radius);
            box-shadow: var(--box-shadow);
            align-items: center;
        }

        #user-input {
            flex: 1;
            padding: 0.75rem 1rem;
            border: 1px solid #cbd5e1;
            border-radius: var(--border-radius);
            outline: none;
            transition: var(--transition);
            font-size: 1rem;
        }

        #user-input:focus {
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.2);
        }

        #send-button {
            background-color: var(--primary-color);
            color: white;
            border: none;
            border-radius: var(--border-radius);
            padding: 0.75rem;
            cursor: pointer;
            transition: var(--transition);
            display: flex;
            align-items: center;
            justify-content: center;
            width: 48px;
            height: 48px;
        }

        #send-button:hover {
            background-color: var(--secondary-color);
        }

        #send-button:disabled {
            background-color: #94a3b8;
            cursor: not-allowed;
        }

        .typing-indicator {
            display: flex;
            align-items: center;
            gap: 0.25rem;
            padding: 0.75rem 1rem;
            color: #64748b;
        }

        .typing-dot {
            width: 8px;
            height: 8px;
            background-color: #64748b;
            border-radius: 50%;
            animation: typingAnimation 1.4s infinite ease-in-out;
        }

        .typing-dot:nth-child(2) {
            animation-delay: 0.2s;
        }

        .typing-dot:nth-child(3) {
            animation-delay: 0.4s;
        }

        @keyframes typingAnimation {
            0%, 60%, 100% { transform: translateY(0); }
            30% { transform: translateY(-5px); }
        }

        .code-container {
            position: relative;
            margin: 0.75rem 0;
            background-color: #1e293b;
            border-radius: var(--border-radius);
            overflow: hidden;
            max-width: 100%;
            width: fit-content;
        }

        .code-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.5rem 1rem;
            background-color: rgba(0, 0, 0, 0.2);
            color: white;
            font-family: 'Fira Code', monospace;
            font-size: 0.8rem;
        }

        .copy-btn {
            background: rgba(255, 255, 255, 0.1);
            border: none;
            color: white;
            padding: 0.25rem 0.5rem;
            border-radius: 4px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 0.25rem;
            font-size: 0.75rem;
            transition: var(--transition);
        }

        .copy-btn:hover {
            background: rgba(255, 255, 255, 0.2);
        }

        .copy-btn i {
            font-size: 0.8rem;
        }

        .code-block {
            padding: 1rem;
            overflow-x: auto;
            max-width: 100%;
        }

        .code-block pre {
            margin: 0;
            font-family: 'Fira Code', 'Courier New', monospace;
            font-size: 0.85rem;
            line-height: 1.5;
            color: #e2e8f0;
            white-space: pre-wrap;
            word-wrap: break-word;
            tab-size: 4;
        }

        .bold-text {
            font-weight: 600;
        }

        .italic-text {
            font-style: italic;
        }

        .underline-text {
            text-decoration: underline;
        }

        .strikethrough-text {
            text-decoration: line-through;
        }

        a {
            color: var(--primary-color);
            text-decoration: none;
            font-weight: 500;
            word-break: break-word;
            border-bottom: 1px solid var(--primary-color);
            padding-bottom: 1px;
        }

        a:hover {
            text-decoration: none;
            border-bottom: 2px solid var(--primary-color);
        }

        .message-content ul {
            list-style-type: disc;
            padding-left: 1.5rem;
            margin: 0.5rem 0;
        }

        .message-content ol {
            list-style-type: decimal;
            padding-left: 1.5rem;
            margin: 0.5rem 0;
        }

        .message-content li {
            margin-bottom: 0.25rem;
        }

        .emoji {
            font-size: 1.2em;
            vertical-align: middle;
            line-height: 1;
        }

        @media (max-width: 768px) {
            .chat-wrapper {
                padding: 0.75rem;
                height: calc(100vh - 62px);
            }
            
            .message {
                max-width: 90%;
            }
            
            .header h1 {
                font-size: 1.25rem;
            }
            
            .clear-chat {
                padding: 0.5rem;
                font-size: 0.8rem;
            }
            
            .code-block pre {
                font-size: 0.8rem;
                padding: 0.75rem;
            }
        }
    </style>
</head>
<body>
    <div class="header">
        <div class="header-content">
            <i class="fas fa-robot"></i>
            <h1>Tosdev Chatbot</h1>
        </div>
        <button class="clear-chat" id="clear-chat">
            <i class="fas fa-trash-alt"></i>
            Clear Chat
        </button>
    </div>
    
    <div class="chat-wrapper">
        <div class="chat-container" id="chat-container">
            <!-- Messages will be loaded from localStorage -->
        </div>
        
        <div class="input-area">
            <input type="text" id="user-input" placeholder="Type your message here..." autocomplete="off">
            <button id="send-button"><i class="fas fa-paper-plane"></i></button>
        </div>
    </div>

    <script>
        const GEMINI_API_KEY = '  ';
        
        const tosdevBio = ` your info`;

        document.addEventListener('DOMContentLoaded', function() {
            const chatContainer = document.getElementById('chat-container');
            const userInput = document.getElementById('user-input');
            const sendButton = document.getElementById('send-button');
            const clearChatButton = document.getElementById('clear-chat');
            let isWaitingForResponse = false;
            
            // Initialize conversation history with your Instagram image
            let conversationHistory = JSON.parse(localStorage.getItem('tosdevChatHistory')) || [
                {
                    role: "bot",
                    content: "",
                    timestamp: new Date().toISOString()
                }
            ];

            // Clear chat function
            function clearChat() {
                if (confirm("Are you sure you want to clear the chat history?")) {
                    conversationHistory = [
                        {
                            role: "bot",
                            content: " ",
                            timestamp: new Date().toISOString()
                        }
                    ];
                    localStorage.setItem('tosdevChatHistory', JSON.stringify(conversationHistory));
                    loadConversationHistory();
                }
            }

            // Load conversation history
            function loadConversationHistory() {
                chatContainer.innerHTML = '';
                conversationHistory.forEach(msg => {
                    if (msg.role === "bot") {
                        addMessageToUI(msg.content, false, msg.timestamp);
                    } else {
                        addMessageToUI(msg.content, true, msg.timestamp);
                    }
                });
            }

            function formatTimestamp(isoString) {
                const date = new Date(isoString);
                return date.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
            }

            function escapeHtml(unsafe) {
                return unsafe
                    .replace(/&/g, "&amp;")
                    .replace(/</g, "&lt;")
                    .replace(/>/g, "&gt;")
                    .replace(/"/g, "&quot;")
                    .replace(/'/g, "&#039;");
            }

            function formatResponse(text) {
                // Escape HTML first
                let safeText = escapeHtml(text);
                
                // First extract and protect images
                const imgRegex = /!\[([^\]]*)\]\(([^)]+)\)/g;
                const imgPlaceholder = '___IMG_PLACEHOLDER___';
                const images = [];
                let imgCounter = 0;
                
                safeText = safeText.replace(imgRegex, function(match, alt, src) {
                    // Convert Instagram URL to embeddable format
                    let embedSrc = src;
                    if (src.includes('instagram.com/p/')) {
                        const postId = src.split('/p/')[1].split('/')[0];
                        embedSrc = `https://www.instagram.com/p/${postId}/embed/`;
                    }
                    images.push({alt, src: embedSrc});
                    return `${imgPlaceholder}${imgCounter++}`;
                });
                
                // Then extract and protect URLs
                const urlRegex = /(https?:\/\/[^\s<]+)/g;
                const urlPlaceholder = '___URL_PLACEHOLDER___';
                const urls = [];
                let urlCounter = 0;
                
                safeText = safeText.replace(urlRegex, function(match) {
                    // Skip if this is already an image URL
                    if (match.includes('![')) return match;
                    
                    // Clean the URL by removing any trailing punctuation
                    let cleanUrl = match.replace(/[.,;:!?)]+$/, '');
                    // Ensure it starts with http if it doesn't
                    if (!cleanUrl.startsWith('http')) {
                        cleanUrl = 'https://' + cleanUrl;
                    }
                    urls.push(cleanUrl);
                    return `${urlPlaceholder}${urlCounter++}`;
                });
                
                // Now process emojis
                const emojiMap = {
                    ':)': '😊', ':(': '😞', ':D': '😃', ':P': '😛',
                    ';)': '😉', ':O': '😮', ':*': '😘', ':|': '😐',
                    ':/': '😕', '<3': '❤️', ':thumbsup:': '👍',
                    ':thumbsdown:': '👎', ':ok_hand:': '👌',
                    ':clap:': '👏', ':wave:': '👋', ':robot:': '🤖',
                    ':computer:': '💻', ':fire:': '🔥', ':rocket:': '🚀',
                    ':lightbulb:': '💡', ':book:': '📚', ':graduation_cap:': '🎓'
                };
                
                for (const [code, emoji] of Object.entries(emojiMap)) {
                    const regex = new RegExp(escapeRegExp(code), 'g');
                    safeText = safeText.replace(regex, `<span class="emoji">${emoji}</span>`);
                }
                
                // Restore images first
                for (let i = 0; i < images.length; i++) {
                    const {alt, src} = images[i];
                    safeText = safeText.replace(
                        `${imgPlaceholder}${i}`, 
                        `<img src="${src}" alt="${alt}"><div class="image-caption">${alt}</div>`
                    );
                }
                
                // Then restore URLs
                for (let i = 0; i < urls.length; i++) {
                    const url = urls[i];
                    const displayUrl = url.replace(/^https?:\/\/(www\.)?/, '');
                    safeText = safeText.replace(
                        `${urlPlaceholder}${i}`, 
                        `<a href="${url}" target="_blank" rel="noopener noreferrer">${displayUrl}</a>`
                    );
                }
                
                // Convert code blocks with copy functionality
                safeText = safeText.replace(/```(\w*)([\s\S]*?)```/g, function(match, lang, code) {
                    const language = lang ? lang : 'code';
                    return `
                    <div class="code-container">
                        <div class="code-header">
                            <span>${language}</span>
                            <button class="copy-btn">
                                <i class="far fa-copy"></i> Copy
                            </button>
                        </div>
                        <div class="code-block">
                            <pre>${code.trim()}</pre>
                        </div>
                    </div>
                    `;
                });
                
                // Convert other formatting
                safeText = safeText
                    .replace(/\*\*(.*?)\*\*/g, '<span class="bold-text">$1</span>')
                    .replace(/\*(.*?)\*/g, '<span class="italic-text">$1</span>')
                    .replace(/__(.*?)__/g, '<span class="underline-text">$1</span>')
                    .replace(/~~(.*?)~~/g, '<span class="strikethrough-text">$1</span>')
                    .replace(/^\s*[\d]+\.\s+(.*$)/gm, '<li>$1</li>')
                    .replace(/^\s*[-*]\s+(.*$)/gm, '<li>$1</li>')
                    .replace(/(<li>.*<\/li>)+/g, '<ul>$&</ul>');
                
                if (!safeText.includes('<pre>')) {
                    safeText = safeText.replace(/\n/g, '<br>');
                }
                
                return safeText;
            }

            function escapeRegExp(string) {
                return string.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
            }

            function addMessageToUI(text, isUser, timestamp) {
                const messageDiv = document.createElement('div');
                messageDiv.classList.add('message');
                
                if (isUser) {
                    messageDiv.innerHTML = `
                        <div class="message-content user-message">
                            ${text}
                            <div class="timestamp">${formatTimestamp(timestamp)}</div>
                        </div>
                    `;
                } else {
                    const formattedText = formatResponse(text);
                    messageDiv.innerHTML = `
                        <div class="message-with-avatar">
                            <div class="bot-avatar">
                                <i class="fas fa-robot"></i>
                            </div>
                            <div>
                                <div class="message-content bot-message">
                                    ${formattedText}
                                </div>
                                <div class="timestamp">${formatTimestamp(timestamp)}</div>
                            </div>
                        </div>
                    `;
                }
                
                chatContainer.appendChild(messageDiv);
                
                // Add copy functionality to new code blocks
                messageDiv.querySelectorAll('.copy-btn').forEach(btn => {
                    btn.addEventListener('click', function() {
                        const codeBlock = this.closest('.code-container').querySelector('pre');
                        const code = codeBlock.textContent;
                        
                        navigator.clipboard.writeText(code).then(() => {
                            const originalText = this.innerHTML;
                            this.innerHTML = '<i class="fas fa-check"></i> Copied!';
                            setTimeout(() => {
                                this.innerHTML = originalText;
                            }, 2000);
                        });
                    });
                });
                
                // Lazy load images
                messageDiv.querySelectorAll('img').forEach(img => {
                    img.loading = 'lazy';
                    // Handle Instagram embeds
                    if (img.src.includes('instagram.com')) {
                        const iframe = document.createElement('iframe');
                        iframe.src = img.src;
                        iframe.width = '100%';
                        iframe.height = '480';
                        iframe.frameBorder = '0';
                        iframe.scrolling = 'no';
                        iframe.allowTransparency = 'true';
                        img.replaceWith(iframe);
                    }
                });
                
                chatContainer.scrollTop = chatContainer.scrollHeight;
            }

            function addMessage(text, isUser) {
                const timestamp = new Date().toISOString();
                conversationHistory.push({
                    role: isUser ? "user" : "bot",
                    content: text,
                    timestamp: timestamp
                });
                
                if (conversationHistory.length > 20) {
                    conversationHistory = conversationHistory.slice(-20);
                }
                
                localStorage.setItem('tosdevChatHistory', JSON.stringify(conversationHistory));
                addMessageToUI(text, isUser, timestamp);
            }

            function showTypingIndicator() {
                if (document.getElementById('typing-indicator')) return;
                
                const typingDiv = document.createElement('div');
                typingDiv.classList.add('message', 'bot-message');
                typingDiv.id = 'typing-indicator';
                typingDiv.innerHTML = `
                    <div class="message-with-avatar">
                        <div class="bot-avatar">
                            <i class="fas fa-robot"></i>
                        </div>
                        <div class="typing-indicator">
                            <span>Typing</span>
                            <div class="typing-dot"></div>
                            <div class="typing-dot"></div>
                            <div class="typing-dot"></div>
                        </div>
                    </div>
                `;
                chatContainer.appendChild(typingDiv);
                chatContainer.scrollTop = chatContainer.scrollHeight;
            }

            function hideTypingIndicator() {
                const typingDiv = document.getElementById('typing-indicator');
                if (typingDiv) {
                    typingDiv.remove();
                }
            }

            function checkIfAboutTosdev(question) {
                const lowerQuestion = question.toLowerCase();
                const tosdevKeywords = [
                    'tosdev', 'tofunmi', 'olawuyi', 'samuel', 
                    'you', 'your', 'yourself', 'about you',
                    'tell me about', 'who are', 'what are',
                    'project', 'portfolio', 'website', 'build',
                    'experience', 'work', 'app', 'application',
                    'blog', 'e-learning', 'voting', 'system'
                ];
                return tosdevKeywords.some(keyword => lowerQuestion.includes(keyword));
            }

            async function getTosdevInfoResponse(question) {
                try {
                    // Create context from recent conversation history
                    const context = conversationHistory
                        .slice(-5)
                        .map(msg => `${msg.role}: ${msg.content}`)
                        .join('\n');
                    
                    const response = await fetch(
                        `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${GEMINI_API_KEY}`,
                        {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({
                                contents: [{
                                    parts: [{
                                        text: `Conversation context:\n${context}\n\nYou are an assistant for . 
                                        Use this information to answer questions about him and his work.
                                        Always mention his portfolio is available at:
                                        You can include images using markdown format:
                                        For Instagram posts, use:
                                        Format your responses with:
                                        - **Bold text** for important points
                                        - *Italic text* for emphasis
                                        - Proper lists with numbers or bullets
                                        - Emojis where appropriate 😊
                                        - Clean URLs that work properly (just show the URL, it will be auto-linked)
                                        - Images using ![alt text](image-url)
                                        - Code blocks wrapped in triple backticks with language specification
                                        
                                        BIOGRAPHY:
                                        ${tosdevBio}
                                        
                                        QUESTION: ${question}
                                        
                                        Respond concisely in 1-5 sentences. If unsure, say:
                                        "I don't have that specific information,"
                                        `
                                    }]
                                }]
                            })
                        }
                    );

                    if (!response.ok) throw new Error('API request failed');
                    const data = await response.json();
                    return data.candidates?.[0]?.content?.parts?.[0]?.text || 
                           "I don't have that specific information. ";

                } catch (error) {
                    console.error("API Error:", error);
                    return "I'm having trouble accessing that information.";
                }
            }

            async function getGeminiResponse(prompt) {
                try {
                    // Create context from recent conversation history
                    const context = conversationHistory
                        .slice(-5)
                        .map(msg => `${msg.role}: ${msg.content}`)
                        .join('\n');
                    
                    const response = await fetch(
                        `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${GEMINI_API_KEY}`,
                        {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({
                                contents: [{
                                    parts: [{
                                        text: `Conversation context:\n${context}\n\nYou are an AI assistant created by . 
                                        When providing responses:
                                        1. Format text properly using **bold**, *italic* and lists
                                        2. Use emojis where appropriate 😊
                                        3. For links, just show the full URL (it will be auto-linked)
                                        4. For images, use markdown format: ![description](image-url)
                                        5. For Instagram posts, use: ![My Instagram Post]()
                                        6. For code blocks, use triple backticks with language specification
                                        7. Use proper numbered or bulleted lists without showing special characters
                                        8. Keep code blocks concise and well-formatted
                                        
                                        Answer this question: ${prompt}`
                                    }]
                                }]
                            })
                        }
                    );

                    if (!response.ok) throw new Error('API request failed');
                    const data = await response.json();
                    return data.candidates?.[0]?.content?.parts?.[0]?.text || 
                           "I'm not sure how to answer that. Could you try asking differently?";

                } catch (error) {
                    console.error("API Error:", error);
                    return "I'm having trouble accessing my knowledge right now. Please try again later.";
                }
            }

            async function handleUserInput() {
                if (isWaitingForResponse) return;
                
                const text = userInput.value.trim();
                if (!text) return;

                addMessage(text, true);
                userInput.value = '';
                isWaitingForResponse = true;
                userInput.disabled = true;
                sendButton.disabled = true;
                
                try {
                    showTypingIndicator();
                    
                    if (checkIfAboutTosdev(text)) {
                        const response = await getTosdevInfoResponse(text);
                        addMessage(response, false);
                    } else {
                        const response = await getGeminiResponse(text);
                        addMessage(response, false);
                    }
                    
                } catch (error) {
                    console.error("Error handling user input:", error);
                    addMessage("Sorry, I encountered an error. Please try again.", false);
                } finally {
                    hideTypingIndicator();
                    isWaitingForResponse = false;
                    userInput.disabled = false;
                    sendButton.disabled = false;
                    userInput.focus();
                }
            }

            // Initial load
            loadConversationHistory();

            // Event listeners
            sendButton.addEventListener('click', handleUserInput);
            clearChatButton.addEventListener('click', clearChat);
            
            userInput.addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    handleUserInput();
                }
            });

            userInput.focus();
        });
    </script>
</body>
</html>
